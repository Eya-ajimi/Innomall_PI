package tn.esprit.gui;

import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.control.TextField;
import javafx.scene.layout.Pane;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;
import tn.esprit.entites.Poste;
import tn.esprit.services.PostService;

import java.io.IOException;
import java.sql.SQLException;
import java.util.List;

public class HomePageController {

    @FXML
    private VBox postsContainer;  // This is the container for all posts

    @FXML
    private TextField postTextField;  // TextField where the user writes the post content

    @FXML
    private Button addPostButton;  // Button to trigger adding a post

    private final PostService postService = new PostService();

    @FXML
    public void initialize() {
        loadPosts();  // Load posts when the page initializes
        setupAddPostButton();  // Setup the button to add a post
    }

    // Setup the Add Post button's action
    private void setupAddPostButton() {
        addPostButton.setOnAction(event -> {
            String postContent = postTextField.getText();  // Get the text from the TextField
            if (!postContent.isEmpty()) {
                Poste newPost = new Poste();
                newPost.setContenu(postContent);
                newPost.setUtilisateurId(15);  // Example user ID, replace with actual user ID if needed

                try {
                    // Insert the post into the database
                    int postId = postService.insert(newPost);

                    // Set the post ID and add it to the UI
                    newPost.setId(postId);
                    addPostToUI(newPost);
                } catch (SQLException e) {
                    e.printStackTrace();  // Handle the exception properly
                }
            }
        });
    }

    // Add the new post to the posts container (UI)
    private void addPostToUI(Poste post) {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/fxml/PostItem.fxml"));
            VBox postBox = loader.load();

            // Get the PostItemController and set post data
            PostItemController controller = loader.getController();
            controller.setPostData(post);

            // Add the post box with its comments to the posts container
            postsContainer.getChildren().add(postBox);

            // Clear the TextField after posting
            postTextField.clear();
        } catch (IOException e) {
            e.printStackTrace();  // Handle the exception properly
        }
    }

    // Load posts and their associated comments
    private void loadPosts() {
        try {
            List<Poste> posts = postService.showAll();  // Get all posts

            // Iterate through each post
            for (Poste post : posts) {
                addPostToUI(post);  // Add the post to the UI
            }
        } catch (SQLException e) {
            e.printStackTrace();  // Log the error
        }
    }
    /**************** redirect****/

    @FXML
    
    private void handleShopsClick() {
        try {
            // Load the Shops.fxml file
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/fxml/Shops.fxml"));
            Pane shopsPage = loader.load();

            // Get the current stage
            Stage stage = (Stage) postsContainer.getScene().getWindow(); // Use an existing node to get the stage
            stage.setScene(new Scene(shopsPage));
            stage.show();

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

}

